; Evaluating file: core-1-1.clj
(ns mimi.summarizer.core
  (:require [clj-http.client :as http]
            [clojure.data.json :as json]
            [clojure.java.io :as io]
            [clojure.string :as str]))

(defn parse-response-body [response]
  (-> response :body json/read-str :key-fn keyword))

(defn post-gpt [query]
  (let [url "https://api.openai.com/v1/chat/completions"
        headers {"Content-Type" "application/json"
                 "Authorization" (str "Bearer " (System/getenv "OPENAI_API_KEY"))}
        body {:model "gpt-3.5-turbo"
              :messages [{:role "user" :content query}]
              :temperature 1.5}
        json-body (json/write-str body)]
    (http/post url {:body (.getBytes json-body "UTF-8")
                    :headers headers})))

(defn query-gpt [query]
  (-> query
      post-gpt
      parse-response-body
      :choices
      first
      :message
      :content))

(defn enhance-file [file-content]
  (str "Your mission is to:
        Please update this file with enhancements without increasing the file size.
        Add new enhancements as clojure code allowing for greater utility.
        Enhancements could be made to this string prompt too.
        If you need more room, please refactor existing code.
        Remember to include new functions and remove any unused code." file-content
       "Here is the file content:"))

(defn process-file [file]
  (let [content (slurp file)
        enhanced-content (enhance-file content)]
    (io/spit file enhanced-content)
    (println (str "done processing " (.getName file)))))

(defn process-dir [target-dir-path]
  (let [files (->> target-dir-path
                   io/file
                   io/file-seq
                   (filter #(.isFile %)))]
    (doseq [file files]
      (process-file file))))

(defn update-file [file-path enhancement]
  (let [content (slurp file-path)
        updated-content (str content enhancement)]
    (io/spit file-path updated-content)))

(defn get-file-size [file-path]
  (-> file-path io/file :file-size))

(defn get-file-lines [file-path]
  (with-open [reader (io/reader file-path)]
    (doall (line-seq reader))))

(defn append-to-file [file-path content]
  (with-open [writer (io/writer file-path :append true)]
    (.write writer content)))

(defn prepend-to-file [file-path content]
  (let [existing-content (slurp file-path)]
    (io/spit file-path (str content existing-content))))

(defn insert-at-line [file-path line content]
  (let [lines (get-file-lines file-path)
        updated-lines (assoc lines line (str (get lines line "\n") content "\n"))]
    (io/spit file-path (clojure.string/join "\n" updated-lines))))

(process-dir "/Users/kingjames/personal/mimi/summerizer/core-1-1.clj")
done processing core-1-1.clj
nil
clj꞉mimi.summarizer.core꞉> 
; Evaluating file: core-1-1.clj
; Syntax error compiling at (summerizer/core-1-1.clj:44:5).
; No such var: io/spit
; Evaluation of file core-1-1.clj failed: class clojure.lang.Compiler$CompilerException
clj꞉mimi.summarizer.core꞉> 
; Evaluating file: core-1-1.clj
; Syntax error compiling at (summerizer/core-1-1.clj:51:20).
; No such var: io/file-seq
; Evaluation of file core-1-1.clj failed: class clojure.lang.Compiler$CompilerException
clj꞉mimi.summarizer.core꞉> 
; Evaluating file: core-1-1.clj
done processing core-1-1.clj
nil
clj꞉mimi.summarizer.core꞉> 
; Evaluating file: core-1-1.clj
done processing core-1-1.clj
nil
clj꞉mimi.summarizer.core꞉> 
; Evaluating file: core-1-1.clj
done processing core-1-1.clj
[nil]
clj꞉mimi.summarizer.core꞉> 
; Evaluating file: core-1-1.clj
done processing core-1-1.clj
nil
clj꞉mimi.summarizer.core꞉> 
; Evaluating file: core-1-1.clj
Done processing core-1-1.clj
nil
clj꞉mimi.summerizer.core꞉> 
; Evaluating file: core-1-1.clj
Done processing core-1-1.clj
nil
clj꞉mimi.summarizer.core꞉> 
; Evaluating file: core-1-1.clj
Done processing core-1-1.clj
nil
clj꞉mimi.summarizer.core꞉> 
; Evaluating file: core-1-1.clj
Done processing core-1-1.clj
nil
clj꞉mimi.summarizer.core꞉> 
; Evaluating file: core-1-1.clj
; Syntax error (ClassCastException) compiling at (summerizer/core-1-1.clj:97:1).
; java.lang.String cannot be cast to clojure.lang.IFn
; Evaluation of file core-1-1.clj failed: class clojure.lang.Compiler$CompilerException
clj꞉mimi.summarizer.core꞉> 
; Evaluating file: core-1-1.clj
Done processing core-1-1.clj
nil
clj꞉mimi.summarizer.core꞉> 
; Evaluating file: core-1-1.clj
Done processing core-1-1.clj
nil
clj꞉mimi.summarizer.core꞉> 
; Evaluating file: core-1-1.clj
Done processing core-1-1.clj
nil
clj꞉mimi.summarizer.core꞉> 
; Evaluating file: core-1-1.clj
Finished enhancing file: core-1-1.clj
nil
clj꞉mimi.summarizer.core꞉> 
; Evaluating file: core-1-1.clj
Completed file enhancement: core-1-1.clj
nil
clj꞉app.core꞉> 
; Evaluating file: core-1-1.clj
Completed file enhancement: core-1-1.clj
nil
clj꞉app.core꞉> 
; Evaluating file: core-1-1.clj
; Syntax error (FileNotFoundException) compiling at (summerizer/core-1-1.clj:56:1).
; /Users/kingjames/personal/mimi/sumizer/core-1-1.clj (No such file or directory)
; Evaluation of file core-1-1.clj failed: class clojure.lang.Compiler$CompilerException
clj꞉app.core꞉> 
; Evaluating file: core-1-1.clj
; Syntax error (IllegalArgumentException) compiling at (summerizer/core-1-1.clj:56:1).
; No matching field found: getName for class java.lang.String
; Evaluation of file core-1-1.clj failed: class clojure.lang.Compiler$CompilerException
clj꞉app.core꞉> 
; Evaluating file: core-1-1.clj
; Syntax error (ExceptionInfo) compiling at (summerizer/core-1-1.clj:56:1).
; clj-http: status 404
; Evaluation of file core-1-1.clj failed: class clojure.lang.Compiler$CompilerException
clj꞉app.core꞉> 
; Evaluating file: core-1-1.clj
; Syntax error (IllegalArgumentException) compiling at (summerizer/core-1-1.clj:56:1).
; No matching field found: getName for class java.lang.String
; Evaluation of file core-1-1.clj failed: class clojure.lang.Compiler$CompilerException
clj꞉app.core꞉> 
; Evaluating file: core-1-1.clj
; Syntax error compiling at (summerizer/core-1-1.clj:43:21).
; No such var: java-io/read
; Evaluation of file core-1-1.clj failed: class clojure.lang.Compiler$CompilerException
clj꞉app.core꞉> 
; Evaluating file: core-1-1.clj
; Syntax error compiling at (summerizer/core-1-1.clj:43:21).
; No such var: java-io/read
; Evaluation of file core-1-1.clj failed: class clojure.lang.Compiler$CompilerException
clj꞉app.core꞉> 
; Evaluating file: core-1-1.clj
; Syntax error (IllegalArgumentException) compiling at (summerizer/core-1-1.clj:51:1).
; No matching field found: getName for class java.lang.String
; Evaluation of file core-1-1.clj failed: class clojure.lang.Compiler$CompilerException
clj꞉app.core꞉> 
(defn md5 [s]
  (let [algorithm (java.security.MessageDigest/getInstance "MD5")
        raw (.digest algorithm (.getBytes s))]
    (format "%032x" (java.math.BigInteger. 1 raw))))
; Syntax error compiling at (.calva/output-window/output.calva-repl:190:19).
; No such namespace: MessageDigest
clj꞉app.core꞉> 
#'app.core/md5
clj꞉app.core꞉> 
(md5 "this is an input string of destiny")
"f891ef772a43bcaa052fac180cd581de"
clj꞉app.core꞉> 
; Evaluating file: core-1-1.clj
; Syntax error (IllegalArgumentException) compiling at (summerizer/core-1-1.clj:56:1).
; No matching field found: getName for class java.lang.String
; Evaluation of file core-1-1.clj failed: class clojure.lang.Compiler$CompilerException
clj꞉app.core꞉> 
; Evaluating file: core-1-1.clj
#'app.core/run-prog
clj꞉app.core꞉> 
; Evaluating file: core-1-1.clj
; Syntax error (IllegalArgumentException) compiling at (summerizer/core-1-1.clj:101:1).
; No matching field found: getName for class java.lang.String
; Evaluation of file core-1-1.clj failed: class clojure.lang.Compiler$CompilerException
clj꞉app.core꞉> 
; Evaluating file: core-1-1.clj
; Syntax error (IllegalArgumentException) compiling at (summerizer/core-1-1.clj:99:1).
; No matching field found: getName for class java.lang.String
; Evaluation of file core-1-1.clj failed: class clojure.lang.Compiler$CompilerException
clj꞉app.core꞉> 
; Evaluating file: core-1-1.clj
; Syntax error (FileNotFoundException) compiling at (summerizer/core-1-1.clj:89:1).
; http://example.com/url1
; Evaluation of file core-1-1.clj failed: class clojure.lang.Compiler$CompilerException
clj꞉app.core꞉> 
; Evaluating file: core-1-1.clj
; Syntax error (IllegalArgumentException) compiling at (summerizer/core-1-1.clj:90:1).
; No matching field found: getName for class java.lang.String
; Evaluation of file core-1-1.clj failed: class clojure.lang.Compiler$CompilerException
clj꞉app.core꞉> 
; Evaluating file: core-1-1.clj
; Syntax error (IllegalArgumentException) compiling at (summerizer/core-1-1.clj:91:1).
; No matching field found: getName for class java.lang.String
; Evaluation of file core-1-1.clj failed: class clojure.lang.Compiler$CompilerException
clj꞉app.core꞉> 
; Evaluating file: core-1-1.clj
File enhancement successful: core-1-1.clj
; Syntax error (FileNotFoundException) compiling at (summerizer/core-1-1.clj:90:1).
; http://example.com/url1
; Evaluation of file core-1-1.clj failed: class clojure.lang.Compiler$CompilerException
clj꞉app.core꞉> 
; Evaluating file: core-1-1.clj
File enhancement successful: core-1-1.clj
; Syntax error (FileNotFoundException) compiling at (summerizer/core-1-1.clj:90:1).
; http://example.com/url1
; Evaluation of file core-1-1.clj failed: class clojure.lang.Compiler$CompilerException
clj꞉app.core꞉> 
; Evaluating file: core-1-1.clj
File enhancement successful: core-1-1.clj
; Syntax error (FileNotFoundException) compiling at (summerizer/core-1-1.clj:89:1).
; http://example.com/url1
; Evaluation of file core-1-1.clj failed: class clojure.lang.Compiler$CompilerException
clj꞉app.core꞉> 
(slurp "https://api.coingecko.com/api/v3/simple/price?ids=bitcoin%2Cethereum&vs_currencies=usd")
"{\"bitcoin\":{\"usd\":29837},\"ethereum\":{\"usd\":1890.24}}"
clj꞉app.core꞉> 
; Evaluating file: core-1-1.clj
File enhancement successful: core-1-1.clj
; Syntax error (FileNotFoundException) compiling at (summerizer/core-1-1.clj:89:1).
; http://example.com/url1
; Evaluation of file core-1-1.clj failed: class clojure.lang.Compiler$CompilerException
clj꞉app.core꞉> 
; Evaluating file: core-1-1.clj
File enhancement successful: core-1-1.clj
nil
clj꞉app.core꞉> 
; Evaluating file: core-1-1.clj
File enhancement successful: core-1-1.clj
nil
clj꞉app.core꞉> 
; Evaluating file: core-1-1.clj
; Syntax error (IllegalArgumentException) compiling at (summerizer/core-1-1.clj:56:1).
; No matching field found: getName for class java.lang.String
; Evaluation of file core-1-1.clj failed: class clojure.lang.Compiler$CompilerException
clj꞉app.core꞉> 
; Evaluating file: core-1-1.clj
; Syntax error (IllegalArgumentException) compiling at (summerizer/core-1-1.clj:56:1).
; No matching field found: getName for class java.lang.String
; Evaluation of file core-1-1.clj failed: class clojure.lang.Compiler$CompilerException
clj꞉app.core꞉> 
