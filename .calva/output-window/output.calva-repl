; Evaluating file: core-1-1.clj
(ns mimi.summarizer.core
  (:require [clj-http.client :as http]
            [clojure.data.json :as json]
            [clojure.java.io :as io]
            [clojure.string :as str]))

(defn parse-response-body [response]
  (-> response :body json/read-str :key-fn keyword))

(defn post-gpt [query]
  (let [url "https://api.openai.com/v1/chat/completions"
        headers {"Content-Type" "application/json"
                 "Authorization" (str "Bearer " (System/getenv "OPENAI_API_KEY"))}
        body {:model "gpt-3.5-turbo"
              :messages [{:role "user" :content query}]
              :temperature 1.5}
        json-body (json/write-str body)]
    (http/post url {:body (.getBytes json-body "UTF-8")
                    :headers headers})))

(defn query-gpt [query]
  (-> query
      post-gpt
      parse-response-body
      :choices
      first
      :message
      :content))

(defn enhance-file [file-content]
  (str "Your mission is to:
        Please update this file with enhancements without increasing the file size.
        Add new enhancements as clojure code allowing for greater utility.
        Enhancements could be made to this string prompt too.
        If you need more room, please refactor existing code.
        Remember to include new functions and remove any unused code." file-content
       "Here is the file content:"))

(defn process-file [file]
  (let [content (slurp file)
        enhanced-content (enhance-file content)]
    (io/spit file enhanced-content)
    (println (str "done processing " (.getName file)))))

(defn process-dir [target-dir-path]
  (let [files (->> target-dir-path
                   io/file
                   io/file-seq
                   (filter #(.isFile %)))]
    (doseq [file files]
      (process-file file))))

(defn update-file [file-path enhancement]
  (let [content (slurp file-path)
        updated-content (str content enhancement)]
    (io/spit file-path updated-content)))

(defn get-file-size [file-path]
  (-> file-path io/file :file-size))

(defn get-file-lines [file-path]
  (with-open [reader (io/reader file-path)]
    (doall (line-seq reader))))

(defn append-to-file [file-path content]
  (with-open [writer (io/writer file-path :append true)]
    (.write writer content)))

(defn prepend-to-file [file-path content]
  (let [existing-content (slurp file-path)]
    (io/spit file-path (str content existing-content))))

(defn insert-at-line [file-path line content]
  (let [lines (get-file-lines file-path)
        updated-lines (assoc lines line (str (get lines line "\n") content "\n"))]
    (io/spit file-path (clojure.string/join "\n" updated-lines))))

(process-dir "/Users/kingjames/personal/mimi/summerizer/core-1-1.clj")
done processing core-1-1.clj
nil
clj꞉mimi.summarizer.core꞉> 
; Evaluating file: core-1-1.clj
; Syntax error compiling at (summerizer/core-1-1.clj:44:5).
; No such var: io/spit
; Evaluation of file core-1-1.clj failed: class clojure.lang.Compiler$CompilerException
clj꞉mimi.summarizer.core꞉> 
; Evaluating file: core-1-1.clj
; Syntax error compiling at (summerizer/core-1-1.clj:51:20).
; No such var: io/file-seq
; Evaluation of file core-1-1.clj failed: class clojure.lang.Compiler$CompilerException
clj꞉mimi.summarizer.core꞉> 
; Evaluating file: core-1-1.clj
done processing core-1-1.clj
nil
clj꞉mimi.summarizer.core꞉> 
; Evaluating file: core-1-1.clj
done processing core-1-1.clj
nil
clj꞉mimi.summarizer.core꞉> 
